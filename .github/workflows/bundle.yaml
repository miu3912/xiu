name: bundle

on:
  push:
    branches:
      - master
      - main
    paths-ignore:
      - dist/**
  workflow_dispatch:

permissions:
  actions: read
  contents: write

concurrency:
  group: ${{ github.workflow }}

jobs:
  bundle:
    if: github.repository != 'StageDog/tavern_helper_template'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JesseTG/rm@v1.0.3
        with:
          path: dist

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - run: pnpm install && pnpm format && pnpm build
      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          default_author: github_actions
          message: '[bot] bundle'
          pull: true
          push: true  # å…³é”®ä¿®å¤ï¼šæ·»åŠ æ¨é€

      # è‡ªåŠ¨æ‰“ç‰ˆæœ¬ tag, ä»è€Œè®© jsdelivr åŸºäºç‰ˆæœ¬å·åœ¨ 12h å†…æ›´æ–°ç¼“å­˜è€Œä¸æ˜¯ç”¨éç‰ˆæœ¬å·çš„ 7d ç¼“å­˜
      - id: autotag
        uses: phish108/autotag-action@v1.1.64
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          with-v: true
      - if: ${{ steps.autotag.outputs.tag != '0.0.0' }}
        run: git push --delete origin ${{ steps.autotag.outputs.tag }}

      # ä¸Šä¼  index.html åˆ° Cloudflare R2
      - name: Upload index.html to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: gobgame-pic
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index.html" ]; then
            echo "é”™è¯¯: dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index.html ä¸å­˜åœ¨"
            echo "æ„å»ºè¾“å‡ºç›®å½•å†…å®¹:"
            ls -la dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
            ls -la dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ || echo "dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          # ä½¿ç”¨ç¯å¢ƒå˜é‡ç›´æ¥ä¸Šä¼ ï¼Œä¸éœ€è¦ aws configure
          # æ·»åŠ å¿…è¦çš„å…ƒæ•°æ®ä»¥ç¡®ä¿ HTML æ­£ç¡®æ˜¾ç¤º
          aws s3 cp dist/å“¥å¸ƒæ—å·¢ç©´-ç®€ç‰ˆ/index.html "s3://${R2_BUCKET}/index.html" \
            --endpoint-url "https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com" \
            --content-type "text/html" \
            --cache-control "no-cache, must-revalidate"

      # ğŸ”¹ æ–°å¢ï¼šæ¸…ç† Cloudflare Edge ç¼“å­˜
      - name: Purge Cloudflare Cache
        env:
          CF_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://kitakamis.online/index.html"]}'
