<template>
  <div v-if="show" class="style-settings-overlay" @click="handleOverlayClick">
    <div class="style-settings-panel" @click.stop>
      <div class="panel-header">
        <h3>ğŸ¨ æ–‡å­—æ ·å¼è®¾ç½®</h3>
        <button class="close-btn" @click="close">Ã—</button>
      </div>

      <div class="panel-content">
        <!-- æ­£æ–‡é¢œè‰² -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">æ­£æ–‡é¢œè‰²</span>
            <span class="label-preview" :style="{ color: textColor }">é¢„è§ˆæ–‡å­—</span>
          </label>
          <input v-model="textColor" type="color" class="color-input" @change="updateStyle" />
        </div>

        <!-- æ–œä½“é¢œè‰² -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">æ–œä½“é¢œè‰²</span>
            <span class="label-preview" :style="{ color: italicColor, fontStyle: 'italic' }">
              <em>é¢„è§ˆæ–œä½“</em>
            </span>
          </label>
          <input v-model="italicColor" type="color" class="color-input" @change="updateStyle" />
        </div>

        <!-- ç²—ä½“é¢œè‰² -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">ç²—ä½“é¢œè‰²</span>
            <span class="label-preview" :style="{ color: strongColor, fontWeight: 'bold' }"> é¢„è§ˆç²—ä½“ </span>
          </label>
          <input v-model="strongColor" type="color" class="color-input" @change="updateStyle" />
        </div>

        <!-- åŒå¼•å·é¢œè‰² -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">åŒå¼•å·é¢œè‰²</span>
            <span class="label-preview" :style="{ color: doubleQuoteColor }">"é¢„è§ˆ"</span>
          </label>
          <input v-model="doubleQuoteColor" type="color" class="color-input" @change="updateStyle" />
        </div>

        <!-- å•å¼•å·é¢œè‰² -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">å•å¼•å·é¢œè‰²</span>
            <span class="label-preview" :style="{ color: singleQuoteColor }">'é¢„è§ˆ'</span>
          </label>
          <input v-model="singleQuoteColor" type="color" class="color-input" @change="updateStyle" />
        </div>

        <!-- åˆ†éš”çº¿ -->
        <div class="divider"></div>

        <!-- æ­£æ–‡å­—ä½“ -->
        <div class="style-item">
          <label class="style-label">
            <span class="label-text">æ­£æ–‡å­—ä½“ï¼ˆç§»åŠ¨ç«¯ä¸æ”¯æŒè‡ªå®šä¹‰å­—ä½“ï¼‰</span>
            <span class="label-preview" :style="{ fontFamily: normalizedFontFamily }">é¢„è§ˆæ–‡å­—</span>
          </label>
          <select v-model="textFont" class="font-select font-preview-select" @change="updateStyle">
            <!-- ä¸­æ–‡å­—ä½“ -->
            <option
              value="'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', 'Hiragino Sans GB', sans-serif"
              :style="{ fontFamily: 'Microsoft YaHei, å¾®è½¯é›…é»‘, PingFang SC, Hiragino Sans GB, sans-serif' }"
            >
              å¾®è½¯é›…é»‘
            </option>
            <option
              value="'SimSun', 'å®‹ä½“', 'STSong', 'Songti SC', serif"
              :style="{ fontFamily: 'SimSun, å®‹ä½“, STSong, Songti SC, serif' }"
            >
              å®‹ä½“
            </option>
            <option
              value="'SimHei', 'é»‘ä½“', 'STHeiti', 'Heiti SC', sans-serif"
              :style="{ fontFamily: 'SimHei, é»‘ä½“, STHeiti, Heiti SC, sans-serif' }"
            >
              é»‘ä½“
            </option>
            <option
              value="'KaiTi', 'æ¥·ä½“', 'Kaiti SC', 'STKaiti', serif"
              :style="{ fontFamily: 'KaiTi, æ¥·ä½“, Kaiti SC, STKaiti, serif' }"
            >
              æ¥·ä½“
            </option>
            <option value="'SimLi', 'éš¶ä¹¦', 'STLiti', serif" :style="{ fontFamily: 'SimLi, éš¶ä¹¦, STLiti, serif' }">
              éš¶ä¹¦
            </option>
            <option
              value="'FangSong', 'ä»¿å®‹', 'FangSong SC', serif"
              :style="{ fontFamily: 'FangSong, ä»¿å®‹, FangSong SC, serif' }"
            >
              ä»¿å®‹
            </option>
            <!-- è¥¿æ–‡å­—ä½“ -->
            <option
              value="Georgia, 'Times New Roman', serif"
              :style="{ fontFamily: 'Georgia, Times New Roman, serif' }"
            >
              Georgia (è¡¬çº¿)
            </option>
            <option value="Arial, 'Helvetica', sans-serif" :style="{ fontFamily: 'Arial, Helvetica, sans-serif' }">
              Arial (æ— è¡¬çº¿)
            </option>
            <option value="Verdana, sans-serif" :style="{ fontFamily: 'Verdana, sans-serif' }">Verdana (æ— è¡¬çº¿)</option>
            <option
              value="'Palatino Linotype', 'Book Antiqua', serif"
              :style="{ fontFamily: 'Palatino Linotype, Book Antiqua, serif' }"
            >
              Palatino (è¡¬çº¿)
            </option>
            <option value="'Courier New', monospace" :style="{ fontFamily: 'Courier New, monospace' }">
              Courier New (ç­‰å®½)
            </option>
          </select>
        </div>

        <!-- é‡ç½®æŒ‰é’® -->
        <div class="style-item">
          <button class="reset-btn" @click="resetStyles">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref, watch } from 'vue';

interface Props {
  show: boolean;
}

const props = defineProps<Props>();
const emit = defineEmits<{ (e: 'close'): void }>();

// é»˜è®¤å€¼
const defaultTextColor = '#f7efd9';
const defaultItalicColor = '#ff69b4';
const defaultStrongColor = '#f7efd9';
const defaultDoubleQuoteColor = '#ffd7a1';
const defaultSingleQuoteColor = '#ffbd7a';
const defaultTextFont = "'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', 'Hiragino Sans GB', sans-serif";

// å“åº”å¼æ•°æ®
const textColor = ref(defaultTextColor);
const italicColor = ref(defaultItalicColor);
const strongColor = ref(defaultStrongColor);
const doubleQuoteColor = ref(defaultDoubleQuoteColor);
const singleQuoteColor = ref(defaultSingleQuoteColor);
const textFont = ref(defaultTextFont);

// è®¡ç®—å±æ€§ï¼šè§„èŒƒåŒ–å­—ä½“åç§°ä¾›é¢„è§ˆä½¿ç”¨ï¼ˆç§»é™¤å¼•å·ï¼‰
const normalizedFontFamily = computed(() => {
  // ç§»é™¤å­—ä½“åç§°ä¸­çš„æ‰€æœ‰å¼•å·ï¼Œä»¥ä¾¿åœ¨ Vue style ç»‘å®šä¸­æ­£ç¡®æ˜¾ç¤º
  return textFont.value.replace(/['"]/g, '');
});

// åŠ è½½ä¿å­˜çš„è®¾ç½®
const loadSavedStyles = () => {
  try {
    const characterVars = getVariables({ type: 'character' });

    if (characterVars['dialogue_text_color']) {
      textColor.value = characterVars['dialogue_text_color'];
    }
    if (characterVars['dialogue_italic_color']) {
      italicColor.value = characterVars['dialogue_italic_color'];
    }
    if (characterVars['dialogue_strong_color']) {
      strongColor.value = characterVars['dialogue_strong_color'];
    }
    if (characterVars['dialogue_double_quote_color']) {
      doubleQuoteColor.value = characterVars['dialogue_double_quote_color'];
    }
    if (characterVars['dialogue_single_quote_color']) {
      singleQuoteColor.value = characterVars['dialogue_single_quote_color'];
    }
    if (characterVars['dialogue_text_font']) {
      // å­—ä½“è¿ç§»ï¼šå°†æ—§çš„å­—ä½“å€¼å‡çº§ä¸ºåŒ…å«ç§»åŠ¨ç«¯æ”¯æŒçš„æ–°å­—ä½“å€¼
      const savedFont = characterVars['dialogue_text_font'];
      const fontMigrationMap: Record<string, string> = {
        "'Microsoft YaHei', 'å¾®è½¯é›…é»‘', sans-serif":
          "'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', 'Hiragino Sans GB', sans-serif",
        "'SimSun', 'å®‹ä½“', serif": "'SimSun', 'å®‹ä½“', 'STSong', 'Songti SC', serif",
        "'SimHei', 'é»‘ä½“', sans-serif": "'SimHei', 'é»‘ä½“', 'STHeiti', 'Heiti SC', sans-serif",
        "'KaiTi', 'æ¥·ä½“', serif": "'KaiTi', 'æ¥·ä½“', 'Kaiti SC', 'STKaiti', serif",
        "'SimLi', 'éš¶ä¹¦', serif": "'SimLi', 'éš¶ä¹¦', 'STLiti', serif",
        "'FangSong', 'ä»¿å®‹', serif": "'FangSong', 'ä»¿å®‹', 'FangSong SC', serif",
      };

      // å¦‚æœæ˜¯æ—§å­—ä½“å€¼ï¼Œè‡ªåŠ¨å‡çº§
      if (fontMigrationMap[savedFont]) {
        textFont.value = fontMigrationMap[savedFont];
        console.log('ğŸ”„ å­—ä½“å·²å‡çº§ä¸ºç§»åŠ¨ç«¯å…¼å®¹ç‰ˆæœ¬:', savedFont, '->', textFont.value);
        // è‡ªåŠ¨ä¿å­˜å‡çº§åçš„å­—ä½“
        saveStyles();
      } else {
        textFont.value = savedFont;
      }
    }

    // åº”ç”¨å·²åŠ è½½çš„è®¾ç½®
    applyStyles();
  } catch (error) {
    console.error('åŠ è½½æ ·å¼è®¾ç½®å¤±è´¥:', error);
  }
};

// åº”ç”¨æ ·å¼åˆ° CSS å˜é‡
const applyStyles = () => {
  const root = document.documentElement;
  root.style.setProperty('--dialogue-text-color', textColor.value);
  root.style.setProperty('--dialogue-italic-color', italicColor.value);
  root.style.setProperty('--dialogue-strong-color', strongColor.value);
  root.style.setProperty('--dialogue-double-quote-color', doubleQuoteColor.value);
  root.style.setProperty('--dialogue-single-quote-color', singleQuoteColor.value);
  root.style.setProperty('--dialogue-text-font', textFont.value);
};

// ä¿å­˜è®¾ç½®åˆ°å˜é‡
const saveStyles = () => {
  try {
    const characterVars = getVariables({ type: 'character' });
    characterVars['dialogue_text_color'] = textColor.value;
    characterVars['dialogue_italic_color'] = italicColor.value;
    characterVars['dialogue_strong_color'] = strongColor.value;
    characterVars['dialogue_double_quote_color'] = doubleQuoteColor.value;
    characterVars['dialogue_single_quote_color'] = singleQuoteColor.value;
    characterVars['dialogue_text_font'] = textFont.value;
    replaceVariables(characterVars, { type: 'character' });
    console.log('æ ·å¼è®¾ç½®å·²ä¿å­˜');
  } catch (error) {
    console.error('ä¿å­˜æ ·å¼è®¾ç½®å¤±è´¥:', error);
  }
};

// æ›´æ–°æ ·å¼
const updateStyle = () => {
  applyStyles();
  saveStyles();
};

// é‡ç½®ä¸ºé»˜è®¤å€¼
const resetStyles = () => {
  textColor.value = defaultTextColor;
  italicColor.value = defaultItalicColor;
  strongColor.value = defaultStrongColor;
  doubleQuoteColor.value = defaultDoubleQuoteColor;
  singleQuoteColor.value = defaultSingleQuoteColor;
  textFont.value = defaultTextFont;
  applyStyles();
  saveStyles();
};

// å…³é—­é¢æ¿
const close = () => {
  emit('close');
};

// ç‚¹å‡»é®ç½©å…³é—­
const handleOverlayClick = () => {
  close();
};

// ç›‘å¬æ˜¾ç¤ºçŠ¶æ€
watch(
  () => props.show,
  newVal => {
    if (newVal) {
      loadSavedStyles();
    }
  },
);

// åˆå§‹åŒ–
onMounted(() => {
  loadSavedStyles();
  applyStyles();
});
</script>

<style scoped lang="scss">
.style-settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease;

  .style-settings-panel {
    background: linear-gradient(135deg, rgba(40, 26, 20, 0.98), rgba(26, 19, 19, 0.98));
    border: 2px solid rgba(205, 133, 63, 0.6);
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
    animation: slideIn 0.3s ease;

    @media (max-width: 768px) {
      width: 95%;
      max-height: 90vh;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 2px solid rgba(205, 133, 63, 0.4);

  h3 {
    margin: 0;
    color: #ffd7a1;
    font-size: 20px;
    font-weight: 700;
  }

  .close-btn {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 28px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    line-height: 1;

    &:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }
  }
}

.panel-content {
  padding: 24px;

  @media (max-width: 768px) {
    padding: 16px;
  }
}

.divider {
  height: 1px;
  background: rgba(205, 133, 63, 0.3);
  margin: 24px 0;
}

.style-item {
  margin-bottom: 24px;

  &:last-child {
    margin-bottom: 0;
  }
}

.style-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;

  .label-text {
    color: #f0e6d2;
    font-weight: 600;
    font-size: 14px;
  }

  .label-preview {
    font-size: 14px;
    opacity: 0.8;
  }
}

.color-input {
  width: 100%;
  height: 40px;
  border: 2px solid rgba(205, 133, 63, 0.4);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    border-color: rgba(205, 133, 63, 0.6);
    transform: translateY(-1px);
  }
}

.font-select {
  width: 100%;
  padding: 10px;
  background: rgba(40, 26, 20, 0.8);
  border: 2px solid rgba(205, 133, 63, 0.4);
  border-radius: 8px;
  color: #f0e6d2;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    border-color: rgba(205, 133, 63, 0.6);
  }

  &:focus {
    outline: none;
    border-color: rgba(205, 133, 63, 0.8);
    box-shadow: 0 0 0 2px rgba(205, 133, 63, 0.2);
  }

  option {
    background: rgba(40, 26, 20, 0.98);
    color: #f0e6d2;
    padding: 8px;
    font-size: 16px;
  }

  // ä¸ºå­—ä½“é€‰æ‹©å™¨çš„é€‰é¡¹å¢åŠ å­—ä½“å¤§å°ï¼Œä¾¿äºé¢„è§ˆ
  &.font-preview-select option {
    font-size: 18px;
    padding: 10px;
  }
}

.reset-btn {
  width: 100%;
  padding: 12px 20px;
  background: linear-gradient(135deg, #8a3c2c, #65261c);
  border: 2px solid rgba(255, 120, 60, 0.5);
  border-radius: 8px;
  color: #ffd7a1;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;

  &:hover {
    background: linear-gradient(135deg, #9a4c3c, #75362c);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }
}
</style>
